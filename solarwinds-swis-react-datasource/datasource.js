/* [create-plugin] version: 5.12.4 */
define(["rxjs","@grafana/runtime","@grafana/data"],((e,t,r)=>(()=>{"use strict";var n={269:t=>{t.exports=e},531:e=>{e.exports=t},781:e=>{e.exports=r}},a={};function o(e){var t=a[e];if(void 0!==t)return t.exports;var r=a[e]={exports:{}};return n[e](r,r.exports,o),r.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};o.r(s),o.d(s,{SwisDatasource:()=>h});var i=o(781),l=o(531),u=o(269);function c(e,t,r,n,a,o,s){try{var i=e[o](s),l=i.value}catch(e){return void r(e)}i.done?t(l):Promise.resolve(l).then(n,a)}function m(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function s(e){c(o,n,a,s,i,"next",e)}function i(e){c(o,n,a,s,i,"throw",e)}s(void 0)}))}}function d(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function f(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){d(e,t,r[t])}))}return e}function p(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}class h extends i.DataSourceApi{testDatasource(){return m((function*(){try{const e=yield this.doRequest({url:this.url+"/Query?query=SELECT Description FROM System.NullEntity",method:"GET"});return 200===e.status?{status:"success",message:"Data source is working :)",title:"Success"}:{status:"error",message:`Error connecting to SWIS: ${e.statusText}`,title:"Error"}}catch(e){return{status:"error",message:`Error connecting to SWIS: ${e}`,title:"Error"}}})).call(this)}interpolateVariable(e,t){return"string"==typeof e&&(t.multi||t.includeAll)?"'"+e.replace(/'/g,"''")+"'":e}query(e){return m((function*(){const t=e.targets.filter((e=>!e.hide)).map((t=>({refId:t.refId,intervalMs:e.intervalMs,maxDataPoints:e.maxDataPoints,rawSql:t.rawSql,format:t.format})));if(0===t.length)return{data:[]};try{const r=t.map((t=>this.doQuery(t,e))),n=yield Promise.all(r);return{data:n.flat()}}catch(e){throw console.error("Query error:",e),e}})).call(this)}doQuery(e,t){return m((function*(){let r=e.rawSql;r=r.replace(/\$from/g,"@timeFrom"),r=r.replace(/\$to/g,"@timeTo"),r=(0,l.getTemplateSrv)().replace(r,t.scopedVars,this.interpolateVariable),e.rawSql=r;const n={query:this.resolveMacros(e.rawSql,t),parameters:{timeFrom:t.range?t.range.from.toISOString():"",timeTo:t.range?t.range.to.toISOString():"",granularity:Math.max(Math.floor((t.intervalMs||0)/1e3),1)}};e.options=t;try{const t=yield this.doRequest({url:this.url+"/Query",method:"POST",data:{query:n.query+" WITH SCHEMAONLY",parameters:n.parameters}});this.processMetadata(t,e);const r=yield this.doRequest({url:this.url+"/Query",method:"POST",data:n});return this.processQueryResult(r,e)}catch(e){throw console.error("Error executing query:",e),e}})).call(this)}timeSpan(e){const t=e%1e3,r=Math.floor(e/1e3)%60,n=Math.floor(e/6e4)%60,a=Math.floor(e/36e5)%24;return Math.floor(e/864e5)+"."+a+":"+n+":"+r+"."+t}resolveMacros(e,t){return-1===(e=e.replace(/downsample\(([^\)]*)*\)/g,((e,t)=>"ADDSECOND(FLOOR(SecondDiff('1970-01-01T00:00:00', "+t+")/@granularity+1)*@granularity, '1970-01-01T00:00:00')"))).indexOf("GRANULARITY")&&-1!==e.indexOf("downsample")&&(e+=" WITH GRANULARITY '"+this.timeSpan(t.intervalMs||0)+"'"),e}processMetadata(e,t){const r=[],n={timeColumnIndex:-1,metricIndex:-1,columns:r};for(const t of e.data.results)-1!==t.DataType.indexOf("String")?n.metricIndex=t.Index:-1!==t.DataType.indexOf("DateTime")&&(n.timeColumnIndex=t.Index),r.push({index:t.Index,name:t.Alias,type:this.translateType(t.DataType)});if("time_series"===t.format){if(r.length<2)throw new Error("There has to be at least 2 columns defined for Series");if(-1===n.timeColumnIndex)throw new Error("Missing DateTime column which is needed for Series")}t.metadata=n}translateType(e){return-1!==e.indexOf("Int")||-1!==e.indexOf("Double")||-1!==e.indexOf("Decimal")?i.FieldType.number:-1!==e.indexOf("DateTime")?i.FieldType.time:-1!==e.indexOf("Boolean")?i.FieldType.boolean:i.FieldType.string}processQueryResult(e,t){if("table"===t.format)return this.processQueryResultTable(e,t);if("time_series"===t.format)return this.processQueryResultMetric(e,t);if("search"===t.format)return this.processQueryResultSearch(e,t);if("annotation"===t.format)return this.processQueryResultAnnotation(e,t);throw new Error("Unknown query format ["+t.format+"]")}processQueryResultAnnotation(e,t){const r=t.metadata;let n=r.columns.findIndex((e=>"time"===e.name));-1===n&&(n=r.timeColumnIndex);let a=r.columns.findIndex((e=>"text"===e.name));-1===a&&(a=r.metricIndex);const o=r.columns.findIndex((e=>"tags"===e.name));if(-1===n)throw new Error("Missing mandatory column DateTime column or named [time]");return e.data.results.map((e=>Object.keys(e).map((t=>e[t])))).map((e=>({annotation:t.options.annotation,time:this.correctTime(e[n]),text:e[a],tags:e[o]?e[o].trim().split(/\s*,\s*/):[]})))}processQueryResultSearch(e,t){const r=t.metadata,n=r.columns.findIndex((e=>"__text"===e.name)),a=r.columns.findIndex((e=>"__value"===e.name));if(2===r.columns.length&&-1!==n&&-1!==a){const t=r.columns[n],o=r.columns[a];return e.data.results.map((e=>Object.keys(e).map((t=>e[t])))).map((e=>({text:e[t.index],value:e[o.index]})))}throw new Error("Specify __text and __value column")}processQueryResultTable(e,t){const r=new i.MutableDataFrame({refId:t.refId,fields:t.metadata.columns.map((e=>({name:e.name,type:e.type})))});return e.data.results.forEach((e=>{const t=Object.keys(e).map((t=>e[t]));r.appendRow(t)})),[r]}correctTime(e){let t=e.indexOf("+");return-1!==t?e=e.substring(0,t)+"Z":e.lastIndexOf("Z")!==e.length-1&&(e+="Z"),Date.parse(e)}processQueryResultMetric(e,t){const r=t.metadata,n=[],a={};for(const o of e.data.results){const e=Object.keys(o).map((e=>o[e])),s=this.correctTime(e[r.timeColumnIndex]);for(let o=0;o<r.columns.length;o++){if(o===r.timeColumnIndex||o===r.metricIndex)continue;let l="";-1!==r.metricIndex&&(l=e[r.metricIndex]),(r.columns.length>3||""===l)&&(""!==l&&(l+="-"),l+=r.columns[o].name);let u=a[l];u||(u=new i.MutableDataFrame({refId:t.refId,name:l,fields:[{name:"Time",type:i.FieldType.time},{name:"Value",type:i.FieldType.number}]}),a[l]=u,n.push(u));const c=e[o];u.appendRow([s,c])}}return n}annotationQuery(e){return m((function*(){if(!e.annotation.query)throw new Error("Query missing in annotation definition");const t={rawSql:e.annotation.query,format:"annotation",metadata:{}};return this.doQuery(t,e)})).call(this)}metricFindQuery(e,t){return m((function*(){const r={rawSql:e,format:"search",metadata:{}};return this.doQuery(r,f({},{intervalMs:0,range:{from:"",to:""},scopedVars:{}},t))})).call(this)}applyTemplateVariables(e,t){return p(f({},e),{rawSql:(0,l.getTemplateSrv)().replace(e.rawSql,t,this.interpolateVariable)})}doRequest(e){return m((function*(){e.withCredentials=this.withCredentials,e.headers=this.headers;try{return yield(0,u.lastValueFrom)((0,l.getBackendSrv)().fetch(e))}catch(e){var t;if(console.error("Request failed:",e),404===e.status)throw new Error("SWIS service is not available");if(null===(t=e.data)||void 0===t?void 0:t.Message)throw new Error(e.data.Message);throw e}})).call(this)}constructor(e){super(e),d(this,"url",void 0),d(this,"withCredentials",void 0),d(this,"headers",void 0),this.url=e.url||"",this.withCredentials=e.withCredentials||!1,this.headers={"Content-Type":"application/json"},"string"==typeof e.basicAuth&&e.basicAuth.length>0&&(this.headers.Authorization=e.basicAuth)}}return s})()));
//# sourceMappingURL=datasource.js.map